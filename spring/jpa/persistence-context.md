# 영속성 컨텍스트란
## 실제 개념

영속성 컨텍스트란 트랜젝션 단위의 엔티티 저장소입니다. 이를 통해 DB와 어플리케이션 사이의 중간 계층 역할을 담당할 수 있습니다. 
### 생성과 범위
JPA의 구현체가 영속성 컨텍스트의 범위와 생명주기를 정할 수 있습니다.

스프링 + JpaTransactionManager의 경우, `@Transactional` 시작 시 생성되고, 트랜젝션이 commit/rollback 시 종료됩니다. 
Java에서는 `EntityManager` 생성 시 시작되고, `close()` 호출 시 종료됩니다. 

### 특징
1. 트랜젝션 단위 : 트랜젝션 안에서만 유지되고, 트랜젝션이 끝나면 영속성 컨텍스트도 종료되면서 엔티티는 준영속 상태로 전한됩니다.
2. 1차 캐시 : `Map<PK, Entity>`로 저장되고, 동작흐름은 다음과 같습니다.
    1. `find()` 호출 시 1차 캐시에서 PK로 조회
    2. 없으면 DB에서 조회 후 1차 캐시에 저장
    3. 동일 PK 재조회 시 DB 접근 없이 캐시에서 반환
3. 변경 감지 : 영속 상태의 엔티티 필드가 변경됐을 때, 자동으로 감지하여 update SQL을 생성합니다
    * 조건 : 엔티티가 영속 상태, 트랜젝션 범위 안, flush 시점 (커밋 직전, jpql/native query 실행 직전, `em.flush()` 호출 시)
    * 동작 방식
        1. 엔티티 저장 시 스냅샷(초기 값 복사본) 생성
        2. flush 시점에 현재 값과 스냅샷 비교
        3. 변경 필드만 반영하는 UPDATE SQL 생성
    * 주의 : flush 타이밍에 대량의 update 발생이 가능하므로, 성능저하에 주의해야 합니다.
1. 쓰기 지연 : update, insert SQL을 직접 실행하지 않고 쓰기 지연 SQL 저장소에 모아두었다가, flush 시 한번에 실행하여 네트워크 I/O를 최소화 합니다. 
1. 엔티티 동일성 보장 : 동일 트랜젝션 내에서 같은 PK의 엔티티는 항상 같은 객체의 인스턴스를 반환합니다.
2. 지연 로딩 지원 : 프록시 객체를 활용하여 필요할 때만 연관 엔티티를 조회할 수 있습니다.

### 내부 구조
```javascript
PersistenceContext {
    Map<EntityKey, EntityEntry> 1차 캐시
    Map<EntityKey, Object>      엔티티 인스턴스 저장소
    ActionQueue                 쓰기 지연 SQL 저장소
}
```
