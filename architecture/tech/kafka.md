# Kafka란

## 실제 개념
Apache Kafka란, 데이터 스트리밍과 이벤트 처리에 적합한 분산 메시징 플랫폼입니다. 
대량 데이터를 빠르고 안정적으로 전달하며, 여러 시스템 간 데이터 통합 및 이벤트 기반 아키텍처에 활용됩니다.
다음 특징을 갖고 있습니다. 
* Pub/Sub 모델 기반의 메시지 큐입니다.
    * Producer: 메시지를 생성하여 Topic에 전송합니다.
    * Consumer: Topic을 구독해서 메시지를 소비합니다.
    * 하나의 Topic에 대해 여러 Consumer 그룹이 동시에 구독할 수 있습니다.
* 초당 수백만 건 이상의 메시지를 처리할 수 있습니다.
* 데이터를 영구 저장할 수 있습니다.
* 분산 환경에서 확장성과 내결함성을 제공합니다???

다음과 같은 상황에서 Kafka를 고려할 수 있습니다. 
* 실시간 대량 데이터를 처리해야 합니다.
* 여러 시스템을 하나의 데이터 파이프라인으로 통합하고 싶습니다.
* 중요한 데이터를 안전하게 처리하고 저장하고 싶습니다.
* 이벤트 기반 마이크로서비스를 구현하고 싶습니다.

### Kafka 클러스터
구성요소는 다음과 같습니다. 
* Broker: Kafka 서버와 Topic, Partition을 관리하고, 메시지를 저장합니다.
* Zookeeper: 클러스터의 메타데이터를 관리하고, Broker의 상태를 모니터링합니다. Partition 리더도 선출합니다.
* Topic: 메시지를 구분하는 논리적인 단위입니다.
* Partition: Topic을 분산 저장하는 단위입니다. Partition 내 순서는 보장합니다.
* Offset: Partition 내 메시지의 위치를 나타내는 값입니다.
클러스터링 규칙은 다음과 같습니다.
* 여러 Broker를 하나의 Cluster로 구성합니다.
* 각 Partition은 Leader와 하나 이상의 Follower(복제본)을 가집니다.
* Leader 장애 시 Follower가 승격합니다.
### 동작 원리
1. Producer가 메시지를 생성하여 특정 Topic에 전송
2. Broker가 메시지를 해당 Topic의 Partition에 저장
3. Consumer 그룹이 Partition을 나누어 병렬로 메시지 처리
4. 각 Consumer는 마지막 읽은 Offset을 저장하여 다음 처리 위치를 기억
5. Broker 간 복제를 통해 장애 발생 시 데이터 손실을 최소화

### 실무
**파티션과 컨슈머 수**
* 원칙: 하나의 Partition은 하나의 Consumer에만 할당됩니다.
* 파티션 > 컨슈머: 일부 컨슈머가 여러 파티션을 처리하여, 과부하 및 지연될 수 있습니다.
* 파티션 < 컨슈머: Idle 컨슈머가 발생할 수 있습니다.
**리벨런싱**
컨슈머 그룹 내에서 파티션 할당을 재조정합니다. (왜?) . 리벨런싱 동안 메시지 처리가 중단되므로, 불필요한 리벨런싱은 최소화되어야 합니다.
다음과 같은 상황에서 발생합니다.
1. 컨슈머 추가 및 제거
2. 파티션 수 변경
3. 컨슈머 실패 및 세션 타임아웃
4. 하트비트(????) 미수신

**장애처리 전략**
* 재시도 & 백오프: 일정 횟수와 시간 간격으로 재시도합니다.
* 데드 레터 큐(DLQ): 실패 메시지를 별도 Topic에 저장하여 분석 및 재처리합니다.
* 트랜젝션 모드:
    * Producer:
    * Consumer:
**스트림 처리**
* Kafka Streams: 자바 기반의 실시간 스트림 처리 라이브러리입니다.
* KSQL(DB): SQL로 스트림 처리가 가능합니다.
    * 복잡한 로직을 SQL로 단순 구현할 수 있습니다.
    * 상태 저장이 가능합니다.
**메시지 전달 보장 수준**
* at most once: 최대 1번 전달. 손실 가능하고, 중복이 없어서 빠릅니다.
* at leat once: 최소 1번 전달. 중복이 가능하고, 손실이 없습니다.
* exactly once: 정확히 1번 전달. 중복과 손실이 없지만 복잡도가 높아집니다.

### AWS Kinesis와 차이
Kinesis란, AWS에서 제공하는 완전 관리형 실시간 스트리밍 데이터 처리 서비스입니다.
로그, 이벤트, IoT 센서 데이터 등 초당 수십만 건 이상의 데이터를 안정적으로 수집, 저장, 처리할 수 있스빈다. 
Kafka처럼 스트리밍 데이터 파이프라인 역할을 하지만, 인프라 구축, 운영, 확장을 관리 없이 바로 사용할 수 있습니다.
크게 4가지 서비스(kinesis data stream, kinesis data firehose, kinesis analytics, kinesis video stream)가 있지만, Kinesis Data Stream만 보겠습니다. 
#### Kinesis Data Stream
실시간 데이터 스트리밍의 핵심 서비스입니다.
* 샤드라는 단위로 데이터를 분할하여 저장합니다.
* 각 샤드는 초당 1MB 쓰기 / 2MB 읽기 처리량을 제공하며, 필요 시 샤드를 늘려서 스케일 아웃이 가능합니다.
* 24시간 ~ 최대 1년 보관이 가능합니다.
* Consumer는 shard의 데이터를 순서대로 읽을 수 있습니다.
* Kinesis는 데이터를 샤드라는 단위로 나누어 저장하고 처리하는데, 같은 Partition Key를 가진 데이터는 항상 같은 샤드에 들어가므로 샤드 내부에서는 순서가 보장됩니다. 소비자는 샤드별로 병렬 처리할 수 있어 처리량을 확장할 수 있지만, 순서가 필요한 데이터는 동일 샤드에 배치되도록 Partition Key를 신중하게 설계해야 합니다.


| 구분     | Kafka                   | Kinesis                           |
| ------ | ----------------------- | --------------------------------- |
| 배포     | 오픈소스, 직접 설치·운영 (또는 MSK) | 완전관리형 (AWS 관리)                    |
| 확장성    | 브로커·파티션 직접 관리           | 샤드 수 변경                           |
| 처리량    | 브로커 스펙, 파티션 수에 따라 조정    | 샤드당 1MB/s 쓰기, 2MB/s 읽기 (샤드 확장 가능) |
| 저장 기간  | 기본 무제한(설정 가능)           | 24시간\~365일                        |
| 비용     | EC2+스토리지+운영비            | 사용한 샤드 수, 데이터 처리량 기반 과금           |
| 지연 시간  | ms\~수백 ms               | 수백 ms\~수 초                        |
| 운영 난이도 | 높음                      | 낮음                                |


