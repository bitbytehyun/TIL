# 락 종류
## row 수준 락
### 공유락 (Shared Lock, S Lock)
읽기용 잠금으로, 다른 트렌젝션도 동시에 읽기는 가능하지만 쓰기는 불가합니다. 
즉, 트랜젝션이 데이터를 읽을 때 거는 락으로, 다른 트랜젝션도 동시에 공유락은 획득이 가능하지만, 베타락은 획득이 불가능합니다.
```sql
SELECT * 
FROM seat 
WHERE seat_id = 10
LOCK IN SHARE MODE;
```
위 쿼리를 통해 두 사용자는 동시에 좌석을 조회할 수 있지만, `UPDATE deat SET status = 'RESERVED'`같은 쓰기 쿼리를 실행하려고 하면 공유락 해제될 때까지 대기합니다. 

주로 다음과 같은 상황에서 사용됩니다.
????
* 조회 무결성 보장: SELECT 결과가 바뀌지 않도록 보호하고 싶을 때 
* 비즈니스 로직에서 읽기 이후 조건 검증: 좌석이 비어있는지 확인 후 예약같은 로직에서 읽기와 쓰기 사이에 값이 

### 베타락 (Exclusive Lock, X Lock)
쓰기용 잠금으로, 다른 트랜젝션이 읽기도 쓰기도 불가능합니다. 
즉, 한 트랜젝션이 베타락을 획득하면, 해당 레코드에 대해 읽기와 쓰기 모두 차단됩니다. 
```sql
SELECT * 
FROM seat 
WHERE seat_id = 10
FOR UPDATE;
```
위 쿼리를 통해, 한 사용자가 좌석을 선택하고 예약을 확정하는 순간 베타락을 획득하고, 다른 사용자는 해당 좌석을 읽으려고 해도 블로킹되어, 동시 예약을 방지할 수 있습니다. 

주로 다음과 같은 상황에서 사용됩니다.
* 데이터 무결성 보장 : 같은 행을 동시에 수정하지 못하게 할 때 
* 동시 예약 / 동시 결제 방지 : 좌석 예약, 재고 차감, 은행 계화 이체 등

## 의도 락
테이블/페이지와 행 락 간 충돌 방지를 위한 신호로,
행 단위 락과 테이블 단위 락이 함께 쓰일 때 충돌을 빠르게 감지하기 위해 신호로 사용됩니다. 
### IS (Intention Shared)
특정 행에 공유락을 걸 예정이라는 신호
### IX (Intention Exclusive)
특정 행에 베타락을 걸 예정이라는 신호
### SIX (Shared + Intension Exclusive)
테이블 전체에는 공유락, 특정 행에는 베타락 예정


## 테이블 락
### Table-level Shared Lock
테이블 전체 읽기 허용, 쓰기 불가
### Table-level Exclusive Lock
* 테이블 전체 단독 접근
* DDL 실행 시, 자동으로 테이블 베타락이 걸립니다.

## 페이지 락
* 데이터 페이지 (여러 행 묶음) 단위로 잠깁니다.
* 행 락보다는 오버헤드가 적고, 테이블락보다 동시성이 높습니다.

## 갭 락 (Gap Lock)

범위를 제어하여 Phantom Read를 방지합니다.
* 행과 행 사이의 간격에 락을 걸어, 새로운 행이 삽입되는 것을 방지합니다. 
* Phantom Read(동일한 쿼리에서 새로운 행이 생겨서 결과가 달라지는 현상)를 방지하는 것을 목적으로 합니다.
`SELECT * FROM users WHERE age BETWEEN 20 AND 30 FOR UPDATE;`를 실행하면, 20~30 전체 범위에 Gap Lock이 걸려서 다른 트랜젝션이 이 구간에 새로운 행을 insert하지 못합니다.
* 주의: 인덱스가 있어야만 갭 단위로 잠금이 걸립니다. 인덱스가 없다면, InnoDB는 범위 제어를 못해서 테이블 락으로 확장될 수 있고 이는 성능저하의 원인이 될 수 있습니다. 

## 넥스트 키 락 (Next-key Lock)

* 레코드 락과 갭 락의 결합한 형태입니다.
* 특정 행을 잠그면서, 그 직전/직후 구간까지 잠그는 방식입니다.
* InnoDB의 Repeatable Read 격리 수준에서 기본적으로 사용합니다.
* 레코드 충돌 뿐만 아니라, 행 사이 gap에서 새로운 데이터가 삽입되어 발생하는 Phantom Read까지 방지할 수 있습니다.

## 자동 증가 락
MySQL에서 AUTO_INCREMENT 칼럼 삽입 시 걸리는 락
## 스키마 락
MySQL에서 ALTER TABLE같은 DDL 실행 시 걸리는 락으로, DDL 도중의 SEELCT, INSERT 충돌을 방지합니다. 
